workflows:
  version: 2
  build-all:
    jobs:
      - build_php
      - build_javascript
  docker:
    - image: tenkoma/php:7.2-apache-sample
      environment:
        DEBUG: true
    - image: circleci/mysql:5.6
      command: mysqld  --character-set-server=utf8mb4 --collation-server=utf8mb4_general_ci
      environment:
        MYSQL_DATABASE: root
        MYSQL_ROOT_PASSWORD: root
  steps:
    - checkout
    - restore_cache: # `composer.lock` が変更されていない場合に、依存関係キャッシュを復元する特別なステップ
    keys:
    - composer-v1-{{ checksum "composer.lock" }}
    # 正確な一致が見つからない場合は、最新のキャッシュの使用にフォールバックします (https://circleci.com/docs/ja/2.0/caching/ を参照)
    - composer-v1-
    - run: composer install -n --prefer-dist
    - run:
        name: create test repot dir
        command: mkdir -p $CIRCLE_TEST_REPORTS/phpunit
    - run:
        name: Wait for MySQL DB
        command: dockerize -wait tcp://localhost:3306 -timeout 1m
    - run:
        name: Initialize Database
        command: bin/cake migrations migrate